#!/bin/bash

# ุงุณฺฉุฑูพุช ุฑุงูโุงูุฏุงุฒ ุณุฑูุฑ ุชููุฏ
# ุงุณุชูุงุฏู: ./deploy.sh

echo "๐ ุดุฑูุน ูุฑุขูุฏ ุงุณุชูุฑุงุฑ ุณุฑูุฑ ุชููุฏ..."

# ุจุฑุฑุณ ูุฌูุฏ Node.js
if ! command -v node &> /dev/null; then
    echo "โ Node.js ุงูุช ูุดุฏ. ูุทูุงู ุงุจุชุฏุง Node.js ุฑุง ูุตุจ ฺฉูุฏ."
    exit 1
fi

# ุจุฑุฑุณ ูุฌูุฏ npm
if ! command -v npm &> /dev/null; then
    echo "โ npm ุงูุช ูุดุฏ. ูุทูุงู ุงุจุชุฏุง npm ุฑุง ูุตุจ ฺฉูุฏ."
    exit 1
fi

echo "๐ฆ ูุตุจ ูุงุจุณุชฺฏโูุง..."
npm ci --production

echo "๐๏ธ ุณุงุฎุช ูุณุฎู ุชููุฏ..."
npm run build

# ุงุฌุงุฏ ูพูุดูโูุง ุถุฑูุฑ
echo "๐ ุงุฌุงุฏ ูพูุดูโูุง ุณุณุชู..."
mkdir -p /var/uploads
mkdir -p /var/backups
mkdir -p /var/logs

# ุชูุธู ูุฌูุฒูุง
echo "๐ ุชูุธู ูุฌูุฒูุง ูุงู..."
chmod 755 /var/uploads
chmod 755 /var/backups
chmod 755 /var/logs

# ฺฉูพ ูุงู ูุญุท ุชููุฏ
if [ -f ".env.production" ]; then
    echo "โ๏ธ ฺฉูพ ุชูุธูุงุช ูุญุท ุชููุฏ..."
    cp .env.production .env.local
else
    echo "โ๏ธ ูุงู .env.production ุงูุช ูุดุฏ!"
fi

echo "โ ุฑุงูโุงูุฏุงุฒ ฺฉุงูู ุดุฏ!"
echo "๐ฏ ุจุฑุง ุดุฑูุน ุณุฑูุฑ ุฏุณุชูุฑ ุฒุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ:"
echo "npm start"

# ุงุฎุชุงุฑ: ุดุฑูุน ุฎูุฏฺฉุงุฑ ุณุฑูุฑ
read -p "ุขุง ูโุฎูุงูุฏ ุณุฑูุฑ ุฑุง ุงูุงู ุดุฑูุน ฺฉูุฏุ (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "๐ ุดุฑูุน ุณุฑูุฑ..."
    npm start
fi
